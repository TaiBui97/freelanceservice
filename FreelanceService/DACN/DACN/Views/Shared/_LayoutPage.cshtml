<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="author" content="Chợ kĩ năng">
    <title>Chợ kĩ năng</title>
    <link rel="stylesheet" href="~/assets/fonts/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="~/assets/fonts/themify-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>

    @Styles.Render("~/bundles/core")
    @Scripts.Render("~/bundles/js")

</head>
<body>
    @RenderPage("~/Views/Shared/Header.cshtml")


    @RenderBody()
    @RenderPage("~/Views/Shared/Footer.cshtml")


    <script src="~/assets/js/main-tain.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    @*<script>
            $(document).ready(function () {
                var chat = $.connection.chatHub;
                chat.client.addChatMessage = function (message) {
                    console.log(message);
                };
                $.connection.hub.start()
                    .done(function () {
                        console.log('Now connected, connection ID=' + $.connection.hub.id);

                        $('#example').DataTable({
                            //data: data
                        });

                        $('#sendmessage').click(function () {
                            // Call the Send method on the hub.
                            chat.server.sendChatMessage("user", $('#message').val());
                            // Clear text box and reset focus for next comment.
                            $('#message').val('').focus();
                        });
                    })
                    .fail(function () { console.log('Could not Connect!'); });
            });
        </script>*@
    <script type="text/javascript">

        $(function () {
            // Reference the auto-generated proxy for the hub.
            var t = document.getElementById("noti").innerText;
            $.connection.hub.qs = { 'uid': '@Html.Raw(Session["mataikhoan"])' };
            var id = @Html.Raw(Session["mataikhoan"]);
            var chat = $.connection.chatHub;
            $.connection.hub.start()
                .done(function () {
                    console.log('Now connected, connection ID=' + $.connection.hub.id);
                    chat.server.checkSeenNotification(id);
                })
                .fail(function () { console.log('Could not Connect!'); });
            // Create a function that the hub can call back to display messages.
            chat.client.addNotification = function (dem,check) {
                //if (t > 0) {
                //    t = t + parseInt(dem);
                //    document.getElementById("noti").innerHTML = t;
                //}
                //else {
                    t = dem;
                document.getElementById("noti").innerHTML = t;
                //}
                if (check == 1) {
                    Swal.fire({
                        type: 'success',
                        title: 'Thông báo đơn hàng',
                        text: 'Đơn hàng của bạn đã được mua vui lòng kiểm tra!'
                    });
                }
                else if (check == 2) {
                    Swal.fire({
                        type: 'success',
                        title: 'Thông báo đơn hàng',
                        text: 'Đơn hàng của bạn đã duyệt vui lòng kiểm tra!'
                    });
                }
                else if (check == 3) {
                    Swal.fire({
                        type: 'error',
                        title: 'Thông báo đơn hàng',
                        text: 'Đơn hàng của bạn đã bị từ chối vui lòng kiểm tra!'
                    });
                }
                else if (check == 4) {
                    Swal.fire({
                        type: 'success',
                        title: 'Thông báo đơn hàng',
                        text: 'Đơn hàng của bạn đã được hoàn thành vui lòng kiểm tra!'
                    });
                }
                else if (check == 5){
                    Swal.fire({
                        type: 'success',
                        title: 'Thông báo đơn hàng',
                        text: 'Đơn hàng của bạn đã được trả tiền vui lòng kiểm tra!'
                    });
                }
            }
           
            chat.client.addChatMessage = function (who, message, uid,inRoom) {
                var audio = new Audio("/assets/ping_tune.wav");
                var expression = /[-a-zA-Z0-9@@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@@:%_\+.~#?&//=]*)?/gi;
                var regex = new RegExp(expression);
                if (message.match(regex)) {
                    console.log('is link');
                    $('#discussion').append('<div class="incoming_msg"><div class="incoming_msg_img"><img src="/assets/img/jobs/img-5.jpg"/></div><div class="received_msg"><div class="received_withd_msg width-msg"><strong>' + htmlEncode(who) + '</strong><br /><p>' + '<a href=' + message + '>'
                        + htmlEncode(message) + '</a> ' + '</div>' + '</div>' + '</div>');
                } else {
                    if (uid == id) {
                        $('#discussion').append('<div class="outgoing_msg"><div class="sent_msg"><div class="received_withd_msg width-msgs"><strong>' + htmlEncode(who)
                            + '</strong><br /><p> ' + htmlEncode(message) + '</p></div></div>');
                    } else {

                        $('#discussion').append('<div class="incoming_msg"><div class="incoming_msg_img"><img src="/assets/img/jobs/img-5.jpg"/></div><div class="received_msg"><div class="received_withd_msg width-msg"><strong>' + htmlEncode(who)
                            + '</strong><br /><p> ' + htmlEncode(message) + '</p></div></div></div>');
                     //   audio.play();
                        chat.server.checkSeenNotification(id);


                    }
                }
                var lastitem = [message];
                let itempop = lastitem.pop();
                document.getElementById("who-write").innerHTML = who + ":";

                document.getElementById("content-msg-ar").innerHTML = itempop;

                $(function () {
                    $('#message-popup').fadeIn('slow', function () {
                        $(this).delay(4000).fadeOut('slow');
                    });
                });
                console.log(t);
                console.log(who);


            }
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

    </script>


</body>
</html>
